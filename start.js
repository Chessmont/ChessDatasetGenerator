#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { spawn } from 'child_process';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);


// Charger la configuration
const configPath = path.join(__dirname, 'config.json');
const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));

class DatasetGenerator {
  constructor() {
    this.srcDir = path.join(__dirname, 'src');
    this.outputDir = path.join(__dirname, 'src', 'output');


    const minElo = config.minOnlineElo;
    const minTime = config.minGameTime;

    this.sourceFiles = {
      twic: path.join(this.outputDir, 'twic.pgn'),
      pgnmentor: path.join(this.outputDir, 'pgnmentor.pgn'),
      chesscom: path.join(this.outputDir, `chesscom-${minElo}-${minTime}.pgn`),
      lichess: path.join(this.outputDir, `lichess-${minElo}-${minTime}.pgn`)
    };

    this.finalPGN = path.join(this.outputDir, config.finalPGNFileName);
    this.officialPGN = path.join(this.outputDir, config.officialPGNFileName);
    this.withOnlineGame = config.withOnlineGame;
  }

  /**
   * Ex√©cute une commande Node.js et retourne une promesse
   */
  runNodeScript(scriptPath, args = []) {
    return new Promise((resolve, reject) => {
      const scriptName = path.basename(scriptPath);
      console.log(`\nüöÄ Lancement: ${scriptName} ${args.join(' ')}`);
      console.time(`‚è±Ô∏è  ${scriptName}`);

      const nodeProcess = spawn('node', [scriptPath, ...args], {
        stdio: 'inherit',
        cwd: __dirname
      });

      nodeProcess.on('close', (code) => {
        console.timeEnd(`‚è±Ô∏è  ${scriptName}`);
        if (code === 0) {
          console.log(`‚úÖ ${scriptName} termin√© avec succ√®s`);
          resolve();
        } else {
          console.error(`‚ùå ${scriptName} a √©chou√© avec le code: ${code}`);
          reject(new Error(`Script ${scriptName} failed with code ${code}`));
        }
      });

      nodeProcess.on('error', (error) => {
        console.timeEnd(`‚è±Ô∏è  ${scriptName}`);
        console.error(`‚ùå Erreur lors du lancement de ${scriptName}:`, error.message);
        reject(error);
      });
    });
  }

  /**
   * V√©rifie si un fichier existe et contient des donn√©es
   */
  checkFile(filePath) {
    try {
      const stats = fs.statSync(filePath);
      const sizeKB = (stats.size / 1024).toFixed(1);
      console.log(`üìÅ ${path.basename(filePath)}: ${sizeKB} KB`);
      return stats.size > 0;
    } catch (error) {
      console.log(`‚ö†Ô∏è  ${path.basename(filePath)}: Non trouv√©`);
      return false;
    }
  }

  /**
   * Affiche un rapport des fichiers g√©n√©r√©s
   */
  showFilesReport() {
    console.log('\nüìä FICHIERS G√âN√âR√âS');
    console.log('===================');

    Object.entries(this.expectedFiles).forEach(([source, filePath]) => {
      this.checkFile(filePath);
    });

    console.log('\nüìã FICHIERS FINAUX');
    console.log('==================');
    this.checkFile(this.finalPGN);
    this.checkFile(this.officialPGN);
  }

  /**
   * T√©l√©charge les donn√©es depuis toutes les sources accept√©es
   */
  async downloadAllSources() {
    console.log('\nüåê PHASE 1: T√âL√âCHARGEMENT DES SOURCES');
    console.log('======================================');


    const mandatoryScripts = [
      path.join(this.srcDir, 'pgn-pgnmentor.js'),
      path.join(this.srcDir, 'pgn-twic.js')
    ];


    const onlineScripts = [
      path.join(this.srcDir, 'pgn-chesscom.js'),
      path.join(this.srcDir, 'pgn-lichess.js')
    ];


    console.log('üì¶ T√©l√©chargement des sources obligatoires (TWIC + PGN Mentor)');
    for (const script of mandatoryScripts) {
      try {
        await this.runNodeScript(script);
      } catch (error) {
        console.error(`‚ö†Ô∏è  √âchec du t√©l√©chargement ${path.basename(script)}, mais on continue...`);
      }
    }


    if (this.withOnlineGame) {
      console.log('üåê T√©l√©chargement des sources en ligne (Chess.com + Lichess)');
      for (const script of onlineScripts) {
        try {
          await this.runNodeScript(script);
        } catch (error) {
          console.error(`‚ö†Ô∏è  √âchec du t√©l√©chargement ${path.basename(script)}, mais on continue...`);
        }
      }
    } else {
      console.log('‚è≠Ô∏è  Sources en ligne d√©sactiv√©es (withOnlineGame: false)');
    }
  }

  /**
   * √âTAPE 2: Compile TWIC + PGN Mentor avec --official
   */
  async compileOfficial() {
    console.log('\nüîß PHASE 2: COMPILATION OFFICIELLE (TWIC + PGN Mentor)');
    console.log('=====================================================');

    const compilScript = path.join(this.srcDir, 'compil.js');
    const officialSources = [this.sourceFiles.twic, this.sourceFiles.pgnmentor];

    console.log(`üì¶ Compilation officielle ‚Üí ${config.officialPGNFileName}`);
    await this.runNodeScript(compilScript, [...officialSources, '--official']);
  }

  /**
   * √âTAPE 3: D√©duplique le fichier officiel
   */
  async deduplicateOfficial() {
    console.log('\nüîÑ PHASE 3: D√âDUPLICATION DU FICHIER OFFICIEL');
    console.log('==============================================');

    const deduplicateScript = path.join(this.srcDir, 'deduplicate-pgn.js');
    console.log(`üßπ D√©duplication ‚Üí ${config.officialPGNFileName}`);
    await this.runNodeScript(deduplicateScript, [this.officialPGN]);
  }

  /**
   * √âTAPE 4: V√©rifie et nettoie les fichiers avec game-checker
   */
  async checkAndCleanGames() {
    console.log('\nüîç PHASE 4: V√âRIFICATION ET NETTOYAGE DES PARTIES');
    console.log('=================================================');

    const gameCheckerScript = path.join(this.srcDir, 'game-checker.js');

    if (this.withOnlineGame) {

      console.log('üåê V√©rification des 3 sources (en ligne + officiel)');

      const filesToCheck = [
        this.sourceFiles.chesscom,
        this.sourceFiles.lichess,
        this.officialPGN
      ];

      for (const file of filesToCheck) {
        if (this.checkFile(file)) {
          console.log(`üîç V√©rification ‚Üí ${path.basename(file)}`);
          await this.runNodeScript(gameCheckerScript, [file]);
        } else {
          console.log(`‚è≠Ô∏è  Fichier absent, ignor√© ‚Üí ${path.basename(file)}`);
        }
      }
    } else {

      console.log('üìÅ V√©rification du fichier officiel uniquement');
      console.log(`üîç V√©rification ‚Üí ${config.officialPGNFileName}`);
      await this.runNodeScript(gameCheckerScript, [this.officialPGN]);
    }
  }

  /**
   * √âTAPE 5: Compile le dataset final (si withOnlineGame = true)
   */
  async compileFinal() {
    if (!this.withOnlineGame) {
      console.log('\n‚è≠Ô∏è  PHASE 5: COMPILATION FINALE IGNOR√âE (withOnlineGame: false)');
      return;
    }

    console.log('\nüîß PHASE 5: COMPILATION FINALE (TOUTES LES SOURCES)');
    console.log('===================================================');

    const compilScript = path.join(this.srcDir, 'compil.js');


    const availableFiles = [];
    const filesToCompile = [
      this.sourceFiles.chesscom,
      this.sourceFiles.lichess,
      this.officialPGN
    ];

    filesToCompile.forEach(file => {
      if (this.checkFile(file)) {
        availableFiles.push(file);
      }
    });

    if (availableFiles.length === 0) {
      throw new Error('Aucun fichier source disponible pour la compilation finale');
    }

    console.log(`üì¶ Compilation finale (${availableFiles.length} sources) ‚Üí ${config.finalPGNFileName}`);
    await this.runNodeScript(compilScript, availableFiles);
  }

  /**
   * √âTAPE 6: Ajoute les IDs au fichier final
   */
  async addIds() {
    console.log('\nüè∑Ô∏è  PHASE 6: AJOUT DES IDs');
    console.log('==========================');

    const addIdsScript = path.join(this.srcDir, 'add-ids.js');


    const sourceFile = this.withOnlineGame ? this.finalPGN : this.officialPGN;
    const sourceLabel = this.withOnlineGame ? config.finalPGNFileName : config.officialPGNFileName;

    console.log(`üè∑Ô∏è  Ajout des IDs ‚Üí ${sourceLabel}`);
    await this.runNodeScript(addIdsScript, [sourceFile]);
  }

  /**
   * √âTAPE 7: G√©n√®re les FENs (optionnel)
   */
  async generateFens() {
    console.log('\n‚ôüÔ∏è  PHASE 7: G√âN√âRATION DES FENs');
    console.log('===============================');

    // V√©rifier si la g√©n√©ration des FENs est activ√©e
    if (!config.generateFen) {
      console.log('‚è≠Ô∏è  G√©n√©ration des FENs d√©sactiv√©e dans la configuration');
      console.log('üí° Pour activer : d√©finir "generateFen": true dans config.json');
      return;
    }

    const fenScript = path.join(this.srcDir, 'fen.js');


    const sourceFile = this.withOnlineGame ? this.finalPGN : this.officialPGN;
    const sourceLabel = this.withOnlineGame ? config.finalPGNFileName : config.officialPGNFileName;

    console.log(`‚ôüÔ∏è  G√©n√©ration FENs depuis ‚Üí ${sourceLabel}`);
    await this.runNodeScript(fenScript, [sourceFile]);
  }
  /**
   * Lance le processus complet de g√©n√©ration selon la configuration
   */
  async generateDataset() {
    const startTime = Date.now();

    console.log('üèÅ G√âN√âRATEUR DE DATASET D\'√âCHECS');
    console.log('==================================');
    console.log(`üìÖ D√©marrage: ${new Date().toLocaleString('fr-FR')}`);
    console.log(`‚öôÔ∏è  Configuration:`);
    console.log(`   ‚Ä¢ ELO minimum: ${config.minOnlineElo}`);
    console.log(`   ‚Ä¢ Temps minimum: ${config.minGameTime}s`);
    console.log(`   ‚Ä¢ Profondeur: ${config.minPlyDepth} coups`);
    console.log(`   ‚Ä¢ Sources en ligne: ${this.withOnlineGame ? 'OUI' : 'NON'}`);

    try {

      await this.downloadAllSources();


      await this.compileOfficial();


      await this.deduplicateOfficial();


      await this.checkAndCleanGames();


      await this.compileFinal();


      await this.addIds();


      // √âTAPE 7: G√©n√©ration des FENs (selon configuration)
      await this.generateFens();


      const duration = ((Date.now() - startTime) / 1000 / 60).toFixed(1);
      console.log('\nüéâ G√âN√âRATION TERMIN√âE AVEC SUCC√àS');
      console.log('==================================');
      console.log(`‚è±Ô∏è  Dur√©e totale: ${duration} minutes`);
      console.log(`üìÖ Fin: ${new Date().toLocaleString('fr-FR')}`);

      this.showFilesReport();

    } catch (error) {
      const duration = ((Date.now() - startTime) / 1000 / 60).toFixed(1);
      console.error('\nüí• ERREUR LORS DE LA G√âN√âRATION');
      console.error('===============================');
      console.error(`‚ùå ${error.message}`);
      console.error(`‚è±Ô∏è  Dur√©e avant √©chec: ${duration} minutes`);

      this.showFilesReport();
      process.exit(1);
    }
  }

  /**
   * Affiche un rapport des fichiers g√©n√©r√©s
   */
  showFilesReport() {
    console.log('\nüìä RAPPORT DES FICHIERS');
    console.log('=======================');

    console.log('\nüìÅ Sources t√©l√©charg√©es:');
    console.log(`   TWIC: ${this.checkFile(this.sourceFiles.twic) ? '‚úÖ' : '‚ùå'}`);
    console.log(`   PGN Mentor: ${this.checkFile(this.sourceFiles.pgnmentor) ? '‚úÖ' : '‚ùå'}`);

    if (this.withOnlineGame) {
      console.log(`   Chess.com: ${this.checkFile(this.sourceFiles.chesscom) ? '‚úÖ' : '‚ùå'}`);
      console.log(`   Lichess: ${this.checkFile(this.sourceFiles.lichess) ? '‚úÖ' : '‚ùå'}`);
    }

    console.log('\nüìã Fichiers finaux:');
    const officialExists = this.checkFile(this.officialPGN);
    const finalExists = this.checkFile(this.finalPGN);

    console.log(`   ${config.officialPGNFileName}: ${officialExists ? '‚úÖ' : '‚ùå'}`);
    if (this.withOnlineGame) {
      console.log(`   ${config.finalPGNFileName}: ${finalExists ? '‚úÖ' : '‚ùå'}`);
    }


    if (officialExists) this.checkFile(this.officialPGN);
    if (finalExists && this.withOnlineGame) this.checkFile(this.finalPGN);
  }
}


const args = process.argv.slice(2);

if (args.includes('--help') || args.includes('-h')) {
  console.log(`
üèÅ G√©n√©rateur de Dataset d'√âchecs
=================================

Usage: node start.js [options]

Options:
  --help, -h     Affiche cette aide

Description:
  Lance le processus complet de g√©n√©ration du dataset d'√©checs selon la configuration.

PROCESSUS (7 √âTAPES):
  1. üåê T√©l√©chargement des sources
     ${config.withOnlineGame ? '‚Ä¢ TWIC, PGN Mentor, Chess.com, Lichess' : '‚Ä¢ TWIC, PGN Mentor uniquement'}

  2. üîß Compilation officielle (TWIC + PGN Mentor ‚Üí ${config.officialPGNFileName})

  3. üîÑ D√©duplication du fichier officiel

  4. üîç V√©rification et nettoyage des parties
     ${config.withOnlineGame ? '‚Ä¢ Chess.com, Lichess, Officiel' : '‚Ä¢ Fichier officiel uniquement'}

  5. üì¶ Compilation finale${config.withOnlineGame ? ` (toutes sources ‚Üí ${config.finalPGNFileName})` : ' (ignor√©e)'}

  6. üè∑Ô∏è  Ajout des IDs au fichier final

  7. ‚ôüÔ∏è  G√©n√©ration des FENs (selon configuration)

Configuration actuelle (config.json):
  ‚Ä¢ ELO minimum: ${config.minOnlineElo}
  ‚Ä¢ Temps minimum: ${config.minGameTime}s
  ‚Ä¢ Profondeur: ${config.minPlyDepth} coups
  ‚Ä¢ Sources en ligne: ${config.withOnlineGame ? 'ACTIV√âES' : 'D√âSACTIV√âES'}
  ‚Ä¢ G√©n√©ration FENs: ${config.generateFen ? 'ACTIV√âE' : 'D√âSACTIV√âE'}

Fichiers g√©n√©r√©s:
  ‚Ä¢ ${config.officialPGNFileName} (dataset officiel filtr√©)
  ${config.withOnlineGame ? `‚Ä¢ ${config.finalPGNFileName} (dataset complet avec sources en ligne)` : ''}
`);
  process.exit(0);
}


const generator = new DatasetGenerator();
generator.generateDataset().catch(error => {
  console.error('Erreur fatale:', error.message);
  process.exit(1);
});
